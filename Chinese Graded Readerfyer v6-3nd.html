<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chinese Graded Reader-fyer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 2. Custom styles for annotation and printing */
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif;
        }
        .unknown-char {
            background-color: #fef9c3; /* Tailwind 'yellow-100' */
            color: #713f12; /* Tailwind 'yellow-900' */
            border-radius: 3px;
            padding: 0 2px;
            text-decoration: none;
            cursor: help;
        }
        .unknown-ref {
            vertical-align: super;
            font-size: 0.75em;
            line-height: 1;
            margin-left: 1px;
            color: #dc2626; /* Tailwind 'red-600' */
            font-weight: bold;
            text-decoration: none;
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media print {
            #input-section, #process-btn, #print-btn { display: none !important; }
            #output-section { width: 100% !important; padding: 0 !important; margin: 0 !important; border: none !important; }
            #progress-section { display: none !important; }
            /* --- NEW: Hide dropdown on print --- */
            #level-select-group { display: none !important; } 
            .unknown-char { background-color: #fef9c3 !important; color: #000 !important; -webkit-print-color-adjust: exact; print-adjust: exact; }
            a { text-decoration: none !important; color: inherit !important; }
            #glossary-list { list-style: decimal !important; margin-left: 2em !important; page-break-before: auto; }
            #annotated-text { font-size: 12pt; line-height: 1.5; }
            h2 { font-size: 16pt !important; padding-top: 1rem; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="max-w-7xl mx-auto p-6 md:p-10">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-900">Chinese Graded Reader-fyer</h1>

        <div id="input-section" class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-6 rounded-lg shadow">
                <label for="known-chars" class="block text-lg font-semibold mb-2">1. Known Words/Characters</label>
                <p class="text-sm text-gray-600 mb-4">Saved list of known items (one per line).</p>

                <div id="level-select-group">
                    <label for="level-select" class="block text-sm font-medium text-gray-700 mb-1 mt-4">Set Mandarin Blueprint Level:</label>
                    <select id="level-select" class="w-full p-2 mb-3 border border-gray-300 rounded-md bg-gray-50 focus:ring-2 focus:ring-blue-500">
                        <option value="">-- Select level--</option>
                        <option value="level1">Level 1</option>
                        <option value="level2">Level 2</option>
                        <option value="level3">Level 3</option>
                        <option value="level4">Level 4</option>
                        <option value="level5">Level 5</option>
                        <option value="level6">Level 6</option>
                        <option value="level7">Level 7</option>
                        <option value="level8">Level 8</option>
                        <option value="level9">Level 9</option>
                        <option value="level10">Level 10</option>
                        <option value="level11">Level 11</option>
                        <option value="level12">Level 12</option>
                        <option value="level13">Level 13</option>
                        <option value="level14">Level 14</option>
                        <option value="level15">Level 15</option>
                        <option value="level16">Level 16</option>
                        <option value="level17">Level 17</option>
                        <option value="level18">Level 18</option>
                        <option value="level19">Level 19</option>
                        <option value="level20">Level 20</option>
                        <option value="level21">Level 21</option>
                        <option value="level22">Level 22</option>
                        <option value="level23">Level 23</option>
                        <option value="level24">Level 24</option>
                        <option value="level25">Level 25</option>
                        <option value="level26">Level 26</option>
                        <option value="level27">Level 27</option>
                        <option value="level28">Level 28</option>
                        <option value="level29">Level 29</option>
                        <option value="level30">Level 30</option>
                        <option value="level31">Level 31</option>
                        <option value="level32">Level 32</option>
                        <option value="level33">Level 33</option>
                        <option value="level34">Level 34</option>
                        <option value="level35">Level 35</option>
                        <option value="level36">Level 36</option>
                        <option value="level37">Level 37</option>
                        <option value="level38">Level 38</option>
                        <option value="level39">Level 39</option>
                        <option value="level40">Level 40</option>
                        <option value="level41">Level 41</option>
                        <option value="level42">Level 42</option>
                        <option value="level43">Level 43</option>
                        <option value="level44">Level 44</option>
                        <option value="level45">Level 45</option>
                        <option value="level46">Level 46</option>
                        <option value="level47">Level 47</option>
                        <option value="level48">Level 48</option>
                        <option value="level49">Level 49</option>
                        <option value="level50">Level 50</option>
                        <option value="level51">Level 51</option>
                        <option value="level52">Level 52</option>
                        <option value="level53">Level 53</option>
                        <option value="level54">Level 54</option>
                        <option value="level55">Level 55</option>
                        <option value="level56">Level 56</option>
                        <option value="level57">Level 57</option>
                        <option value="level58">Level 58</option>
                        <option value="level59">Level 59</option>
                        <option value="level60">Level 60</option>
                        <option value="level61">Level 61</option>
                        <option value="level62">Level 62</option>
                        <option value="level63">Level 63</option>
                        <option value="level64">Level 64</option>
                        <option value="level65">Level 65</option>
                        <option value="level66">Level 66</option>
                        <option value="level67">Level 67</option>
                        <option value="level68">Level 68</option>
                        <option value="level69">Level 69</option>
                        <option value="level70">Level 70</option>
                        <option value="level71">Level 71</option>
                        <option value="level72">Level 72</option>
                        <option value="level73">Level 73</option>
                        <option value="level74">Level 74</option>
                        <option value="level75">Level 75</option>
                        <option value="level76">Level 76</option>
                        <option value="level77">Level 77</option>
                        <option value="level78">Level 78</option>
                        <option value="level79">Level 79</option>
                        <option value="level80">Level 80</option>
                        <option value="level81">Level 81</option>
                        <option value="level82">Level 82</option>
                        <option value="level83">Level 83</option>
                        <option value="level84">Level 84</option>
                        <option value="level85">Level 85</option>
                        <option value="level86">Level 86</option>
                        <option value="level87">Level 87</option>
                        <option value="level88">Level 88</option>
                        </select>
                </div>
                <textarea id="known-chars" rows="10" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="Loading repository..."></textarea>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow">
                <label for="input-text" class="block text-lg font-semibold mb-2">2. Text to Analyze</label>
                <p class="text-sm text-gray-600 mb-4">Paste the full Chinese text you want to read here. (New words will be highlighted.)</p>
                <textarea id="input-text" rows="10" class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500" placeholder="ä»Šå¤©å¤©æ°”å¾ˆå¥½ï¼Œæˆ‘ä»¬åŽ»å…¬å›­çŽ©å„¿å§ã€‚"></textarea>
            </div>
        </div>

        <div class="text-center mb-8">
            <button id="process-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 text-lg flex items-center justify-center w-64 mx-auto disabled:opacity-75" style="min-height: 60px;" disabled>
                <span class="loader"></span>
                Loading Repository...
            </button>
        </div>

        <div id="output-section" class="bg-white p-6 md:p-10 rounded-lg shadow-lg hidden">
            <button id="print-btn" onclick="window.print()" class="float-right -mt-4 bg-gray-700 text-white font-semibold py-2 px-5 rounded-md hover:bg-gray-800 transition">
                Save as PDF
            </button>
            
            <h2 class="text-2xl font-bold mb-6 border-b pb-3">Analyzed Text</h2>

            <div id="progress-section" class="mb-8 bg-blue-50 p-4 rounded-lg border border-blue-100">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-medium text-blue-700" id="progress-text">Knowledge Coverage</span>
                    <span class="text-sm font-medium text-blue-700" id="progress-percent">0%</span>
                </div>
                <div class="w-full bg-blue-200 rounded-full h-4">
                    <div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                </div>
                <p id="progress-details" class="text-xs text-blue-600 mt-2 text-center">
                    </p>
            </div>
            <div id="annotated-text" class="text-lg leading-relaxed whitespace-pre-wrap">
                </div>

            <h2 class="text-2xl font-bold mt-12 mb-6 border-b pb-3">Unknown Word Glossary</h2>
            <p class="text-sm text-gray-600 mb-4">A list of all unknown words/characters found in the text, in order of appearance. Definitions come from the **embedded dictionary**.</p>
            <ol id="glossary-list" class="list-decimal list-inside space-y-4">
                </ol>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const FULL_EMBEDDED_DICTIONARY = {
            // Your dictionary entries...
            "%": { pinyin: ["pa1"], definition: "percent (Tw)"},
            "110": { pinyin: ["yao1 yao1 ling2"], definition: "the emergency number for law enforcement in Mainland China and Taiwan"},
            "119": { pinyin: ["yao1 yao1 jiu3"], definition: "the emergency number for firefighting services in Mainland China"},
            "$11åŒº": { pinyin: ["Shi2 yi1 Qu1"], definition: "(ACG) Japan (from the anime Code Geass, in which Japan was renamed Area 11) "},
            "120": { pinyin: ["yao1 er4 ling2"], definition: "the emergency number for medical assistance and first aid in Mainland China"},
            "2019å† çŠ¶ç—…æ¯’ç—…": { pinyin: ["er4 ling2 yi1 jiu3 guan1 zhuang4 bing4 du2 bing4"], definition: "COVID-19, the coronavirus disease identified in 2019"},
            "21ä¸‰ä½“ç»¼åˆç—‡": { pinyin: ["er4 shi2 yi1 san1 ti3 zong1 he2 zheng4"], definition: "trisomy; Down's syndrome"},
            "é©®": { pinyin: ["tuo2"], definition: "variant of é¦±|é©®[tuo2]"},
            "ä¯": { pinyin: ["sui3"], definition: "variant of é«“[sui3]"},
            "é­‚": { pinyin: ["hun2"], definition: "old variant of é­‚[hun2]"},
            "é²ƒ": { pinyin: ["ba1"], definition: "used in ä°¾é­š|é²ƒé±¼[ba1 yu2]"},
            "é²ƒé±¼": { pinyin: ["ba1 yu2"], definition: "barbel (fish)"},
            "é³š": { pinyin: ["wei4"], definition: "blenny"},
            "ä²”": { pinyin: ["jing1"], definition: "old variant of é¯¨|é²¸[jing1]"},
            "é³¤": { pinyin: ["guan3"], definition: "Ochetobius elongatus, species of cyprinid fish found in eastern Asia"},
            "ä³—": { pinyin: ["e2"], definition: "variant of éµ|é¹…[e2]"},
            "é¹…": { pinyin: ["e2"], definition: "variant of éµ|é¹…[e2]"},
            "ä³­": { pinyin: ["ji2"], definition: "wheatear (bird of genus Oenanthe)"},
            "é¹®": { pinyin: ["huan2"], definition: "spoonbill/ibis/family Threskiornithidae"},
            "é¹®å˜´é¹¬": { pinyin: ["huan2 zui3 yu4"], definition: "(bird species of China) ibisbill (Ibidorhyncha struthersii)"},
            "ä¸€ä¹‹ä¸ºç”š": { pinyin: ["yi1 zhi1 wei2 shen4"], definition: "once is more than enough (idiom)"},
            "é¿¬": { pinyin: ["tian2"], definition: "tennessine (chemistry)" },
            // Add your other words like ä½ , å¥½, å—, çˆ¸çˆ¸, å¦ˆå¦ˆ, etc. here for the logic to work
            "ä½ ": { pinyin: "nÇ", definition: "you" },
            "å¥½": { pinyin: "hÇŽo", definition: "good" },
            "å—": { pinyin: "ma", definition: "question particle" },
            "æˆ‘": { pinyin: "wÇ’", definition: "I, me" },
            "ä»–": { pinyin: "tÄ", definition: "he, him" },
            "å¥¹": { pinyin: "tÄ", definition: "she, her" },
            "ä»¬": { pinyin: "men", definition: "plural marker" },
            "å§": { pinyin: "ba", definition: "modal particle" },
            "è§": { pinyin: "jiÃ n", definition: "to see" },
            "å†è§": { pinyin: "zÃ ijiÃ n", definition: "goodbye" },
            "ä¸": { pinyin: "bÃ¹", definition: "not" },
            "çˆ¸çˆ¸": { pinyin: "bÃ ba", definition: "dad" },
            "å¦ˆå¦ˆ": { pinyin: "mÄma", definition: "mom" },
            "å“¥å“¥": { pinyin: "gÄ“ge", definition: "older brother" },
            "å§å§": { pinyin: "jiÄ›jie", definition: "older sister" },
            "å–œæ¬¢": { pinyin: "xÇhuan", definition: "to like" },
            "åƒ": { pinyin: "chÄ«", definition: "to eat" },
            "å–": { pinyin: "hÄ“", definition: "to drink" },
            "æ°´": { pinyin: "shuÇ", definition: "water" },
            "åå­—": { pinyin: "mÃ­ngzi", definition: "name" },
            "ä»Šå¤©": { pinyin: "jÄ«n tiÄn", definition: "today" },
            "å¤©æ°”": { pinyin: "tiÄn qÃ¬", definition: "weather" },
            "å¾ˆ": { pinyin: "hÄ›n", definition: "very" },
            "æˆ‘ä»¬": { pinyin: "wÇ’ men", definition: "we, us" },
            "åŽ»": { pinyin: "qÃ¹", definition: "to go" },
            "å…¬å›­": { pinyin: "gÅng yuÃ¡n", definition: "park" },
            "çŽ©å„¿": { pinyin: "wÃ¡nr", definition: "to play" }
        };

        const DICTIONARY_KEYS_SORTED = Object.keys(FULL_EMBEDDED_DICTIONARY).sort((a, b) => b.length - a.length);

        // ===================================
        // === NEW: Word Lists Data ===
        // ===================================
        const PRESET_WORD_LISTS = {
            "level1": "ä½  å¥½ å— æˆ‘ ä»– å¥¹ ä»¬ å§ è§ å†è§ ä¸",
            "level2": "çˆ¸çˆ¸ å¦ˆå¦ˆ å“¥å“¥ å§å§ å–œæ¬¢ åƒ å– æ°´ åå­—",
            "level3": "",
            "level4": "",
            "level5": "",
            "level6": "",
            "level7": "",
            "level8": "",
            "level9": "",
            "level10": "",
            "level11": "",
            "level12": "",
            "level13": "",
            "level14": "",
            "level15": "",
            "level16": "",
            "level17": "",
            "level18": "",
            "level19": "",
            "level20": "",
            "level21": "",
            "level22": "",
            "level23": "",
            "level24": "",
            "level25": "",
            "level26": "",
            "level27": "",
            "level28": "",
            "level29": "",
            "level30": "",
            "level31": "",
            "level32": "",
            "level33": "",
            "level34": "",
            "level35": "",
            "level36": "",
            "level37": "",
            "level38": "",
            "level39": "",
            "level40": "",
            "level41": "",
            "level42": "",
            "level43": "",
            "level44": "",
            "level45": "",
            "level46": "",
            "level47": "",
            "level48": "",
            "level49": "",
            "level50": "",
            "level51": "",
            "level52": "",
            "level53": "",
            "level54": "",
            "level55": "",
            "level56": "",
            "level57": "",
            "level58": "",
            "level59": "",
            "level60": "",
            "level61": "",
            "level62": "",
            "level63": "",
            "level64": "",
            "level65": "",
            "level66": "",
            "level67": "",
            "level68": "",
            "level69": "",
            "level70": "",
            "level71": "",
            "level72": "",
            "level73": "",
            "level74": "",
            "level75": "",
            "level76": "",
            "level77": "",
            "level78": "",
            "level79": "",
            "level80": "",
            "level81": "",
            "level82": "",
            "level83": "",
            "level84": "",
            "level85": "",
            "level86": "",
            "level87": "",
            "level88": "",
            // Add more levels here, e.g.:
            // "level3": "word1 word2 word3"
        };
        // ===================================
        // === END NEW ===
        // ===================================

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let firestoreKnownSet = new Set();
        const KNOWN_CHARS_INPUT = document.getElementById('known-chars');
        const INPUT_TEXT = document.getElementById('input-text');
        const PROCESS_BTN = document.getElementById('process-btn');
        const OUTPUT_SECTION = document.getElementById('output-section');
        const ANNOTATED_TEXT_DIV = document.getElementById('annotated-text');
        const GLOSSARY_LIST = document.getElementById('glossary-list');
        // --- NEW: Get the dropdown element ---
        const LEVEL_SELECT = document.getElementById('level-select'); 

        const KNOWN_CHARACTERS_COLLECTION = 'chinese_repository';
        const KNOWN_CHARACTERS_DOC_ID = 'known_list';

        function getUserDocRef() {
            if (!db || !userId) return null;
            return doc(db, 'artifacts', appId, 'users', userId, KNOWN_CHARACTERS_COLLECTION, KNOWN_CHARACTERS_DOC_ID);
        }

        // This function remains unchanged from your file
        function setupRealtimeListener() {
            const docRef = getUserDocRef();
            if (!docRef) {
                console.error("No DocRef. Fallback to local input.");
                PROCESS_BTN.disabled = false;
                PROCESS_BTN.innerHTML = 'Analyze Text';
                KNOWN_CHARS_INPUT.placeholder = 'Could not load repository. Using local input only.';
                return;
            }

            onSnapshot(docRef, (doc) => {
                let knownCharsString = '';
                if (doc.exists()) {
                    const data = doc.data();
                    knownCharsString = data.knownCharacters || '';
                }
                const knownItems = knownCharsString.split(/[\s\n,]+/).filter(Boolean);
                firestoreKnownSet = new Set(knownItems);
                
                // --- This logic is from your original file ---
                // It only updates the box on the first load, which is correct.
                // This allows you to manually edit the box after loading a level.
                if (KNOWN_CHARS_INPUT.placeholder === 'Loading repository...') {
                     KNOWN_CHARS_INPUT.value = Array.from(firestoreKnownSet).join('\n');
                     KNOWN_CHARS_INPUT.placeholder = 'Paste all your known words and characters here (one per line)...';
                }
                // --- End original logic ---

                PROCESS_BTN.disabled = false;
                PROCESS_BTN.innerHTML = 'Analyze Text';
                PROCESS_BTN.querySelector('.loader').style.display = 'none';
            }, (error) => {
                console.error("Error loading repository from database:", error);
                PROCESS_BTN.disabled = false;
                PROCESS_BTN.innerHTML = 'Analyze Text (Repo Error)';
                PROCESS_BTN.querySelector('.loader').style.display = 'none';
                KNOWN_CHARS_INPUT.placeholder = 'Error loading persistent data. Using local input only.';
            });
        }
        
        // This function remains unchanged from your file
        async function saveKnownCharacters(knownCharsString) {
            const docRef = getUserDocRef();
            if (!docRef) {
                console.error("Cannot save: Database not initialized or User ID missing.");
                return;
            }
            try {
                await setDoc(docRef, { knownCharacters: knownCharsString });
            } catch (error) {
                console.error("Failed to save known characters:", error);
            }
        }

        // This function remains unchanged from your file
        function getDefinition(item) {
            if (FULL_EMBEDDED_DICTIONARY.hasOwnProperty(item)) {
                const entry = FULL_EMBEDDED_DICTIONARY[item];
                const pinyin = Array.isArray(entry.pinyin) ? entry.pinyin.join(', ') : entry.pinyin;
                return {
                    pinyin: pinyin,
                    definition: entry.definition
                };
            }
            return {
                pinyin: "??",
                definition: "Definition not found in the local dictionary."
            };
        }

        // This function remains unchanged from your file
        PROCESS_BTN.addEventListener('click', async () => {
            PROCESS_BTN.disabled = true;
            PROCESS_BTN.innerHTML = '<span class="loader"></span> Processing...';
            OUTPUT_SECTION.classList.add('hidden');
            ANNOTATED_TEXT_DIV.innerHTML = '';
            GLOSSARY_LIST.innerHTML = '';

            const inputText = INPUT_TEXT.value;
            const knownCharsInput = KNOWN_CHARS_INPUT.value;

            // 1. Get current known set
            const currentKnownItems = new Set(knownCharsInput.split(/[\s\n,]+/).filter(Boolean));
            
            let annotatedHtml = '';
            const glossary = [];
            const glossaryIndexMap = new Map();
            const newItemsFound = new Set();
            let glossaryIndexCounter = 1; 
            let i = 0;

            // 2. Iterate through the text (Main Annotation Loop)
            while (i < inputText.length) {
                const char = inputText[i];

                if (char === '\n') {
                    annotatedHtml += '<br>';
                    i++;
                    continue;
                }
                if (!char.match(/[\u4e00-\u9fff]/)) {
                    annotatedHtml += char;
                    i++;
                    continue;
                }

                // 3. Maximal Match
                let matchFound = false;
                for (const key of DICTIONARY_KEYS_SORTED) {
                    if (inputText.startsWith(key, i)) {
                        matchFound = true;
                        if (!currentKnownItems.has(key)) {
                            // UNKNOWN word
                            const def = getDefinition(key);
                            let refIndex;
                            if (glossaryIndexMap.has(key)) {
                                refIndex = glossaryIndexMap.get(key);
                            } else {
                                refIndex = glossaryIndexCounter++;
                                glossaryIndexMap.set(key, refIndex);
                                glossary.push({ item: key, index: refIndex, pinyin: def.pinyin, definition: def.definition });
                            }
                            newItemsFound.add(key);
                            annotatedHtml += `<a href="#g${refIndex}" class="unknown-char" title="${key} (${def.pinyin}): ${def.definition}">` +
                                             `${key}` + 
                                             `<sup id="t${refIndex}" class="unknown-ref"> ${refIndex}</sup>` +
                                             `</a>`;
                        } else {
                            // KNOWN word
                            annotatedHtml += key;
                        }
                        i += key.length;
                        break;
                    }
                }

                // 5. Fallback
                if (!matchFound) {
                    const singleChar = inputText[i];
                    if (!currentKnownItems.has(singleChar)) {
                        // UNKNOWN single char
                        const def = getDefinition(singleChar);
                        let refIndex;
                        if (glossaryIndexMap.has(singleChar)) {
                            refIndex = glossaryIndexMap.get(singleChar);
                        } else {
                            refIndex = glossaryIndexCounter++;
                            glossaryIndexMap.set(singleChar, refIndex);
                            glossary.push({ item: singleChar, index: refIndex, pinyin: def.pinyin, definition: def.definition });
                        }
                        newItemsFound.add(singleChar);
                        annotatedHtml += `<a href="#g${refIndex}" class="unknown-char" title="${singleChar} (${def.pinyin}): ${def.definition}">` +
                                         `${singleChar}` + 
                                         `<sup id="t${refIndex}" class="unknown-ref"> ${refIndex}</sup>` +
                                         `</a>`;
                    } else {
                        // KNOWN single char
                        annotatedHtml += singleChar;
                    }
                    i++;
                }
            } // End of while-loop (text processing)

            
            // --- Progress Bar Calculation ---
            let totalMeaningfulItems = 0;
            let knownItemsCount = 0;
            let j = 0;
            while (j < inputText.length) {
                const char = inputText[j];
                if (!char.match(/[\u4e00-\u9fff]/)) { j++; continue; }
                let itemFound = false;
                for (const key of DICTIONARY_KEYS_SORTED) {
                    if (inputText.startsWith(key, j)) {
                        totalMeaningfulItems++;
                        if (currentKnownItems.has(key)) {
                            knownItemsCount++;
                        }
                        j += key.length;
                        itemFound = true;
                        break;
                    }
                }
                if (!itemFound) {
                    totalMeaningfulItems++;
                    if (currentKnownItems.has(inputText[j])) {
                        knownItemsCount++;
                    }
                    j++;
                }
            }
            const coveragePercent = totalMeaningfulItems > 0 ? Math.round((knownItemsCount / totalMeaningfulItems) * 100) : 0;
            requestAnimationFrame(() => {
                document.getElementById('progress-bar').style.width = `${coveragePercent}%`;
            });
            document.getElementById('progress-percent').textContent = `${coveragePercent}%`;
            document.getElementById('progress-text').textContent = `You know ${coveragePercent}% of this text!`;
            document.getElementById('progress-details').textContent = `You know ${knownItemsCount} out of ${totalMeaningfulItems} total words/characters.`;
            
            // 6. Inject annotated text
            ANNOTATED_TEXT_DIV.innerHTML = annotatedHtml;

            // 7. Inject glossary
            if (glossary.length === 0) {
                GLOSSARY_LIST.innerHTML = '<li class="text-gray-600">No unknown words or characters found! ðŸŽ‰</li>';
            } else {
                glossary.sort((a, b) => a.index - b.index);
                
                GLOSSARY_LIST.innerHTML = glossary.map(item => `
                    <li id="g${item.index}" class="p-3 bg-gray-50 rounded-md hover:bg-gray-100 transition duration-150">
                        <span class="text-red-600 font-bold mr-2">(${item.index})</span>
                        <span class="text-2xl font-serif text-gray-900 mr-4">${item.item}</span> 
                        <span class="font-semibold text-blue-700 mr-2">${item.pinyin}</span>:
                        ${item.definition}
                        <a href="#t${item.index}" class="text-xs text-gray-500 float-right hover:text-gray-700 transition">Jump to Text</a>
                    </li>
                `).join('');
            }

            // 8. Update the Known Characters list (this part from your code stops auto-add)
            const allKnownItems = Array.from(currentKnownItems);
            const newKnownItemsString = allKnownItems.join('\n');
            KNOWN_CHARS_INPUT.value = newKnownItemsString;
            
            // 9. Save the updated repository to Firestore
            await saveKnownCharacters(newKnownItemsString);

            // 10. Display output and reset button
            OUTPUT_SECTION.classList.remove('hidden');
            PROCESS_BTN.disabled = false;
            PROCESS_BTN.innerHTML = 'Analyze Text';
        });

        // ===================================
        // === NEW: Dropdown Logic (Replaces instead of Adds) ===
        // ===================================
        LEVEL_SELECT.addEventListener('change', async (e) => {
            const selectedLevel = e.target.value;
            if (!selectedLevel) return; // Do nothing if they selected the default "--" option

            const newWordsString = PRESET_WORD_LISTS[selectedLevel];
            if (!newWordsString) {
                console.error("No word list found for:", selectedLevel);
                return;
            }

            // 1. Get new words from the preset list
            const newWordsArray = newWordsString.split(' ');

            // 2. Format them with newlines (this is the *replacement* string)
            const replacementString = newWordsArray.join('\n');

            // 3. Update the textarea
            KNOWN_CHARS_INPUT.value = replacementString;

            // 4. Save to the database using your *existing* save function
            // This ensures the change is permanent
            await saveKnownCharacters(replacementString);

            // 5. Reset the dropdown so you can select it again
            //e.target.value = "";
        });
        // ===================================
        // === END NEW ===
        // ===================================


        // --- Firebase Initialization (Unchanged) ---
        async function initializeFirebase() {
            try {
                // setLogLevel('debug');

                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    console.error("Firebase configuration is missing or incomplete.");
                    KNOWN_CHARS_INPUT.value = 'Cannot connect to database. Please use local input only.';
                    KNOWN_CHARS_INPUT.disabled = false;
                    PROCESS_BTN.disabled = false;
                    PROCESS_BTN.innerHTML = 'Analyze Text';
                    PROCESS_BTN.querySelector('.loader').style.display = 'none';
                    return;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        setupRealtimeListener();
                    } else {
                        userId = crypto.randomUUID();
                        console.warn("Signed in anonymously or using fallback ID:", userId);
                        setupRealtimeListener();
                    }
                });
            } catch (error) { 
                console.error("Firebase initialization failed:", error);
                KNOWN_CHARS_INPUT.value = 'Paste your known characters here.';
                PROCESS_BTN.disabled = false;
                PROCESS_BTN.innerHTML = 'Analyze Text';
                PROCESS_BTN.querySelector('.loader').style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>